graphs:

  # Metric calculation graph
  - id: PPG
    nodes:
      - id: sub_ppg
        module: timeflux.nodes.zmq
        class: Sub
        params:
          topics: [ppg_filtered]
      - id: peak_detector
        module: timeflux_dsp.nodes.peaks
        class: LocalDetect
        params:
          delta: 0.3
          tol: 0.05
      - id: event_to_signal
        module: timeflux.nodes.events
        class: EventToSignal
        params:
          label: 'peak'
          keys: null
      - id: rolling
        module: timeflux.nodes.window
        class: Slide
        params:
          length: 10
          step: 1
          rate: 1
      - id: hrv_calculator
        module: nodes.HRVTimeDomainCalculator
        class: HRVTimeDomainCalculator
      - id: select_column
        module: timeflux.nodes.query
        class: LocQuery
        params:
          key: ["HRV_SDNN", "HRV_RMSSD", "HRV_pNN50", "HRV_SDSD", "HRV_MeanNN"]
          axis: 1
      - id: stress_metric
        module: nodes.PPG_StressMetric
        class: StressMetric
        params:
          weights: {'HRV_SDNN': 0.33, 'HRV_RMSSD': 0.33, 'HRV_pNN50': 0.34}
      - id: attention_metric
        module: nodes.PPG_AttentionMetric
        class: AttentionMetric
        params:
          weights: {'HRV_SDNN': 0.30, 'HRV_RMSSD': 0.40, 'HRV_pNN50': 0.30}
      - id: cognitive_load_metric
        module: nodes.PPG_CognitiveLoadMetric
        class: CognitiveLoadMetric
        params:
          weights: {'HRV_SDNN': 0.5, 'HRV_RMSSD': 0.5}
      - id: arousal_metric
        module: nodes.PPG_ArousalMetric
        class: ArousalMetric
        params:
          weights: {'HRV_SDSD': 0.33, 'HRV_RMSSD': 0.33, 'HRV_MeanNN': 0.34}
      - id: pub_stress_metric
        module: timeflux.nodes.zmq
        class: Pub
        params:
            topic: ppg_stress_metric
      - id: pub_attention_metric
        module: timeflux.nodes.zmq
        class: Pub
        params:
            topic: ppg_attention_metric
      - id: pub_cognitive_load_metric
        module: timeflux.nodes.zmq
        class: Pub
        params:
            topic: ppg_cognitive_load_metric
      - id: pub_arousal_metric
        module: timeflux.nodes.zmq
        class: Pub
        params:
            topic: ppg_arousal_metric
      - id: display
        module: timeflux.nodes.debug
        class: Display
      - id: pub_hrv
        module: timeflux.nodes.zmq
        class: Pub
        params:
            topic: hrv_data
    edges:
      - source: sub_ppg:ppg_filtered
        target: peak_detector
      - source: peak_detector
        target: event_to_signal
      - source: event_to_signal
        target: rolling
      - source: rolling
        target: hrv_calculator
      - source: hrv_calculator
        target: select_column
      - source: hrv_calculator
        target: pub_hrv
      - source: select_column
        target: stress_metric
      - source: stress_metric
        target: pub_stress_metric
      - source: select_column
        target: attention_metric
      - source: attention_metric
        target: pub_attention_metric
      - source: select_column
        target: cognitive_load_metric
      - source: cognitive_load_metric
        target: pub_cognitive_load_metric
      - source: select_column
        target: arousal_metric
      - source: arousal_metric
        target: pub_arousal_metric
    rate: 1